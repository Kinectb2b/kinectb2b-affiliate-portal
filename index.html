<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KinectB2B Affiliate Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --deep-blue: #0F172A; --electric-blue: #2563EB; --white: #FFFFFF;
            --slate-gray: #64748B; --light-gray: #F8FAFC; --border-gray: #E2E8F0;
            --success-green: #10B981; --warning-yellow: #F59E0B; --danger-red: #EF4444;
        }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--deep-blue); background-color: var(--light-gray); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        h1, h2, h3 { font-weight: 800; line-height: 1.2; }
        .btn { display: inline-block; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; border: none; cursor: pointer; text-align: center; }
        .btn-primary { background-color: var(--electric-blue); color: var(--white); }
        .btn-primary:hover { background-color: #1D4ED8; }
        .btn-success { background-color: var(--success-green); color: var(--white); }
        .btn-danger { background-color: var(--danger-red); color: var(--white); }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; }
        .card { background: var(--white); border-radius: 12px; padding: 2rem; box-shadow: 0 4px 15px rgba(15, 23, 42, 0.08); margin-bottom: 2rem; }
        .header { background: var(--white); padding: 1rem 0; box-shadow: 0 2px 10px rgba(15, 23, 42, 0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--deep-blue); }
        .nav-links { display: flex; gap: 2rem; align-items: center; }
        .nav-links a { text-decoration: none; color: var(--slate-gray); font-weight: 500; cursor: pointer; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--deep-blue) 0%, #1E293B 100%); padding: 1rem; }
        .login-card { max-width: 400px; width: 100%; }
        .login-card .card { background: var(--white); border-radius: 16px; padding: 3rem; text-align: center; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 3rem; }
        .stat-card { background: linear-gradient(135deg, var(--electric-blue), #3B82F6); color: var(--white); text-align: center; }
        .stat-number { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        .stat-label { font-size: 1rem; opacity: 0.9; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray); }
        th { background: var(--light-gray); font-weight: 600; color: var(--deep-blue); }
        .tabs { display: flex; border-bottom: 2px solid var(--border-gray); margin-bottom: 2rem; overflow-x: auto; }
        .tab { padding: 1rem 2rem; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--slate-gray); transition: all 0.3s ease; white-space: nowrap; }
        .tab.active { color: var(--electric-blue); border-bottom: 2px solid var(--electric-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--deep-blue); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid var(--border-gray); border-radius: 8px; font-size: 1rem; }
        .hidden { display: none; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--slate-gray); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 8px; color: var(--white); font-weight: 600; z-index: 1001; transform: translateX(400px); transition: transform 0.3s ease; }
        .notification.success { background: var(--success-green); }
        .notification.error { background: var(--danger-red); }
        .notification.show { transform: translateX(0); }
        .status-badge { padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: #FEF3C7; color: #D97706; }
        .status-contacted { background: #DBEAFE; color: #2563EB; }
        .status-active { background: #D1FAE5; color: #059669; }
        .status-closed { background: #FEE2E2; color: #DC2626; }
        .status-customer { background: #D1FAE5; color: #059669; }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--white);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--slate-gray);
        }
    </style>
</head>
<body>
    <div id="login-section" class="login-container">
        <div class="login-card">
            <div class="card">
                <div class="logo" style="margin-bottom: 2rem;">KinectB2B Affiliates</div>
                <div id="login-form">
                    <h2>Login</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">Login</button>
                    </form>
                    <p style="text-align: center; color: var(--slate-gray); font-size: 0.9rem;">
                        <button onclick="showAdminLogin()" style="background: none; border: none; color: var(--electric-blue); text-decoration: underline; cursor: pointer;">Admin Access</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <header class="header hidden" id="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">KinectB2B Affiliates</div>
                <nav class="nav-links">
                    <span id="user-name">Loading...</span>
                    <a onclick="logout()">Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <div id="admin-portal" class="hidden">
        <div class="container" style="padding-top: 2rem;">
            <div class="dashboard-grid">
                <div class="card stat-card">
                    <div class="stat-number" id="admin-total-affiliates">0</div>
                    <div class="stat-label">Total Affiliates</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="admin-total-referrals">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="admin-monthly-revenue">$0</div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="admin-total-commissions">$0</div>
                    <div class="stat-label">Total Commissions</div>
                </div>
            </div>

            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="showAdminTab(event, 'affiliates')">Affiliates</button>
                    <button class="tab" onclick="showAdminTab(event, 'referrals-admin')">Referrals</button>
                    <button class="tab" onclick="showAdminTab(event, 'payments-admin')">Payments</button>
                    <button class="tab" onclick="showAdminTab(event, 'questions-admin')">Questions</button>
                </div>
                <div id="admin-content">
                    <div class="empty-state">
                        <div class="empty-state-icon">⚙️</div>
                        <h3>Admin Dashboard</h3>
                        <p>Select a tab to manage your affiliate program.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Affiliate Portal -->
    <div id="affiliate-portal" class="hidden">
        <div class="container" style="padding-top: 2rem;">
            <!-- Affiliate Stats -->
            <div class="dashboard-grid">
                <div class="card stat-card">
                    <div class="stat-number" id="total-referrals">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="active-clients">0</div>
                    <div class="stat-label">Active Clients</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="monthly-earnings">$0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="total-earnings">$0</div>
                    <div class="stat-label">Total Earned</div>
                </div>
            </div>

            <!-- Affiliate Tabs -->
            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="showAffiliateTab(event, 'my-referrals')">My Referrals</button>
                    <button class="tab" onclick="showAffiliateTab(event, 'submit-referral')">Submit Referral</button>
                    <button class="tab" onclick="showAffiliateTab(event, 'my-payments')">My Payments</button>
                    <button class="tab" onclick="showAffiliateTab(event, 'support-qa')">Support & Q&A</button>
                    <button class="tab" onclick="showAffiliateTab(event, 'profile-settings')">Profile & Payment</button>
                    <button class="tab" onclick="showAffiliateTab(event, 'affiliate-info')">How It Works</button>
                </div>

                <!-- Affiliate Content -->
                <div id="affiliate-content">
                    <!-- My Referrals Tab -->
                    <div id="my-referrals-content" class="tab-content active">
                        <h3>My Referrals</h3>
                        <div id="affiliate-referrals-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">📋</div>
                                <h3>No Referrals Yet</h3>
                                <p>Submit your first referral to start earning commissions!</p>
                                <button class="btn btn-primary" onclick="showAffiliateTab(null, 'submit-referral')" style="margin-top: 1rem;">Submit Referral</button>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Referral Tab -->
                    <div id="submit-referral-content" class="tab-content">
                        <h3>Submit New Referral</h3>
                        <form id="affiliate-referral-form">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <h4 style="margin-bottom: 1rem;">Company Information</h4>
                                    <div class="form-group">
                                        <label for="ref-company-name">Company Name *</label>
                                        <input type="text" id="ref-company-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="ref-company-website">Website</label>
                                        <input type="url" id="ref-company-website">
                                    </div>
                                    <div class="form-group">
                                        <label for="ref-company-size">Company Size</label>
                                        <select id="ref-company-size">
                                            <option value="">Select size...</option>
                                            <option value="1-10">1-10 employees</option>
                                            <option value="11-50">11-50 employees</option>
                                            <option value="51-200">51-200 employees</option>
                                            <option value="200+">200+ employees</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 1rem;">Contact Information</h4>
                                    <div class="form-group">
                                        <label for="ref-contact-name">Contact Name *</label>
                                        <input type="text" id="ref-contact-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="ref-contact-email">Email *</label>
                                        <input type="email" id="ref-contact-email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="ref-contact-phone">Phone</label>
                                        <input type="tel" id="ref-contact-phone">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="ref-notes">Additional Notes</label>
                                <textarea id="ref-notes" placeholder="Tell us about their business, current challenges, or why they'd be a good fit..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Referral</button>
                        </form>
                    </div>

                    <!-- My Payments Tab -->
                    <div id="my-payments-content" class="tab-content">
                        <h3>My Payment History</h3>
                        <div id="affiliate-payments-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">💰</div>
                                <h3>No Payments Yet</h3>
                                <p>Payments will appear here once your referrals become active clients.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Support & Q&A Tab -->
                    <div id="support-qa-content" class="tab-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3>Support & Questions</h3>
                            <button class="btn btn-primary btn-small" onclick="openQuestionModal()">Ask New Question</button>
                        </div>
                        
                        <div id="affiliate-questions-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">❓</div>
                                <h3>No Questions Yet</h3>
                                <p>Have a question about the affiliate program, payments, or need help? Our team is here to help!</p>
                                <button class="btn btn-primary" onclick="openQuestionModal()" style="margin-top: 1rem;">Ask Your First Question</button>
                            </div>
                        </div>
                    </div>

                    <!-- Profile & Payment Settings Tab -->
                    <div id="profile-settings-content" class="tab-content">
                        <h3>Profile & Payment Settings</h3>
                        
                        <!-- Personal Information -->
                        <div style="margin-bottom: 3rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--electric-blue);">Personal Information</h4>
                            <form id="personal-info-form">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                    <div class="form-group">
                                        <label for="profile-full-name">Full Name *</label>
                                        <input type="text" id="profile-full-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-phone">Phone Number *</label>
                                        <input type="tel" id="profile-phone" required>
                                    </div>
                                </div>
                                
                                <h5 style="margin-bottom: 1rem;">Mailing Address</h5>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label for="profile-address">Street Address *</label>
                                        <input type="text" id="profile-address" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-address2">Apt/Unit</label>
                                        <input type="text" id="profile-address2">
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                                    <div class="form-group">
                                        <label for="profile-city">City *</label>
                                        <input type="text" id="profile-city" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-state">State *</label>
                                        <input type="text" id="profile-state" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-zip">ZIP Code *</label>
                                        <input type="text" id="profile-zip" required>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Update Personal Info</button>
                            </form>
                        </div>

                        <!-- Payment Method Selection -->
                        <div style="margin-bottom: 3rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--electric-blue);">Payment Method</h4>
                            <form id="payment-method-form">
                                <div class="form-group">
                                    <label>Choose your preferred payment method:</label>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                                        <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-gray); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onclick="selectPaymentMethod('paypal')">
                                            <input type="radio" name="payment-method" value="paypal" id="payment-paypal" style="margin-right: 0.5rem;">
                                            <span>💰 PayPal</span>
                                        </label>
                                        <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-gray); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onclick="selectPaymentMethod('zelle')">
                                            <input type="radio" name="payment-method" value="zelle" id="payment-zelle" style="margin-right: 0.5rem;">
                                            <span>📱 Zelle</span>
                                        </label>
                                        <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-gray); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onclick="selectPaymentMethod('cashapp')">
                                            <input type="radio" name="payment-method" value="cashapp" id="payment-cashapp" style="margin-right: 0.5rem;">
                                            <span>💸 Cash App</span>
                                        </label>
                                        <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-gray); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onclick="selectPaymentMethod('ach')">
                                            <input type="radio" name="payment-method" value="ach" id="payment-ach" style="margin-right: 0.5rem;">
                                            <span>🏦 ACH Transfer</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- PayPal Details -->
                                <div id="paypal-details" class="payment-details" style="display: none; margin-top: 1rem;">
                                    <div class="form-group">
                                        <label for="paypal-email">PayPal Email Address *</label>
                                        <input type="email" id="paypal-email" placeholder="your-email@example.com">
                                    </div>
                                </div>

                                <!-- Zelle Details -->
                                <div id="zelle-details" class="payment-details" style="display: none; margin-top: 1rem;">
                                    <div class="form-group">
                                        <label>Zelle Contact Info *</label>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <input type="email" id="zelle-email" placeholder="Email linked to Zelle">
                                            <input type="tel" id="zelle-phone" placeholder="Phone linked to Zelle">
                                        </div>
                                        <small style="color: var(--slate-gray);">Enter either email OR phone number that's linked to your Zelle account</small>
                                    </div>
                                </div>

                                <!-- Cash App Details -->
                                <div id="cashapp-details" class="payment-details" style="display: none; margin-top: 1rem;">
                                    <div class="form-group">
                                        <label for="cashapp-tag">Cash App Tag *</label>
                                        <input type="text" id="cashapp-tag" placeholder="$YourCashTag">
                                    </div>
                                </div>

                                <!-- ACH Details -->
                                <div id="ach-details" class="payment-details" style="display: none; margin-top: 1rem;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label for="ach-account">Account Number *</label>
                                            <input type="text" id="ach-account" placeholder="Account Number">
                                        </div>
                                        <div class="form-group">
                                            <label for="ach-routing">Routing Number *</label>
                                            <input type="text" id="ach-routing" placeholder="Routing Number">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="ach-bank-name">Bank Name</label>
                                        <input type="text" id="ach-bank-name" placeholder="Bank Name">
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Save Payment Method</button>
                            </form>
                        </div>

                        <!-- Social Media Links -->
                        <div style="margin-bottom: 3rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--electric-blue);">Social Media & Promotion Links</h4>
                            <p style="color: var(--slate-gray); margin-bottom: 1.5rem;">Add links to your social accounts where you'll be promoting KinectB2B as an affiliate.</p>
                            <form id="social-links-form">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                    <div>
                                        <div class="form-group">
                                            <label for="social-facebook">🔗 Facebook Profile/Page</label>
                                            <input type="url" id="social-facebook" placeholder="https://facebook.com/yourpage">
                                        </div>
                                        <div class="form-group">
                                            <label for="social-instagram">📸 Instagram Profile</label>
                                            <input type="url" id="social-instagram" placeholder="https://instagram.com/yourusername">
                                        </div>
                                        <div class="form-group">
                                            <label for="social-linkedin">💼 LinkedIn Profile</label>
                                            <input type="url" id="social-linkedin" placeholder="https://linkedin.com/in/yourname">
                                        </div>
                                    </div>
                                    <div>
                                        <div class="form-group">
                                            <label for="social-twitter">🐦 Twitter/X Profile</label>
                                            <input type="url" id="social-twitter" placeholder="https://twitter.com/yourusername">
                                        </div>
                                        <div class="form-group">
                                            <label for="social-youtube">📺 YouTube Channel</label>
                                            <input type="url" id="social-youtube" placeholder="https://youtube.com/yourchannel">
                                        </div>
                                        <div class="form-group">
                                            <label for="social-website">🌐 Personal Website/Blog</label>
                                            <input type="url" id="social-website" placeholder="https://yourwebsite.com">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Social Links</button>
                            </form>
                        </div>
                    </div>

                    <!-- How It Works / Affiliate Info Tab -->
                    <div id="affiliate-info-content" class="tab-content">
                        <div style="max-width: 800px;">
                            <h3 style="color: var(--electric-blue); margin-bottom: 2rem;">KinectB2B Affiliate Program - How It Works</h3>
                            
                            <!-- What is an Affiliate -->
                            <div style="margin-bottom: 3rem;">
                                <h4 style="color: var(--electric-blue); margin-bottom: 1rem;">🤝 What is an Affiliate?</h4>
                                <p style="margin-bottom: 1rem;">As a KinectB2B affiliate, you're our trusted partner who helps us connect with businesses that need our lead generation and appointment setting services. You act as a bridge between KinectB2B and potential clients who could benefit from our expertise.</p>
                                <p style="margin-bottom: 1rem;">Think of it as being a matchmaker - you identify businesses that struggle with lead generation or need more appointments, and you introduce them to our proven solutions.</p>
                            </div>

                            <!-- How You Make Money -->
                            <div style="margin-bottom: 3rem;">
                                <h4 style="color: var(--success-green); margin-bottom: 1rem;">💰 How You Earn Commissions</h4>
                                <div style="background: var(--light-gray); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                                    <h5 style="color: var(--electric-blue); margin-bottom: 1rem;">Simple 4-Step Process:</h5>
                                    <div style="display: grid; gap: 1.5rem;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="background: var(--electric-blue); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                                            <div>
                                                <strong>Submit Referral:</strong> You find a business that needs lead generation and submit their info through this portal
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="background: var(--electric-blue); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</div>
                                            <div>
                                                <strong>We Contact Them:</strong> Our sales team reaches out and presents our services to your referral
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="background: var(--success-green); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                                            <div>
                                                <strong>They Become a Client:</strong> If they sign up for one of our Pro Plans, you earn a commission
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="background: var(--success-green); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">4</div>
                                            <div>
                                                <strong>Get Paid:</strong> You receive 10% of their first month's payment via your chosen payment method
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Commission Structure -->
                            <div style="margin-bottom: 3rem;">
                                <h4 style="color: var(--success-green); margin-bottom: 1rem;">💵 Commission Structure</h4>
                                <div style="background: linear-gradient(135deg, var(--success-green), #059669); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 3rem; font-weight: bold; margin-bottom: 0.5rem;">10%</div>
                                        <div style="font-size: 1.2rem;">Commission on First Month Payment</div>
                                    </div>
                                </div>
                                <div style="background: var(--light-gray); padding: 2rem; border-radius: 12px;">
                                    <h5 style="margin-bottom: 1rem;">Example Earnings:</h5>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                                            <div style="font-weight: bold; color: var(--electric-blue);">Pro Plan 300</div>
                                            <div style="color: var(--slate-gray);">$750/month</div>
                                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">$75</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                                            <div style="font-weight: bold; color: var(--electric-blue);">Pro Plan 600</div>
                                            <div style="color: var(--slate-gray);">$1,500/month</div>
                                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">$150</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                                            <div style="font-weight: bold; color: var(--electric-blue);">Pro Plan 1000</div>
                                            <div style="color: var(--slate-gray);">$2,500/month</div>
                                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-green);">$250</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Best Prospects -->
                            <div style="margin-bottom: 3rem;">
                                <h4 style="color: var(--electric-blue); margin-bottom: 1rem;">🎯 Who Makes a Great Referral?</h4>
                                <div style="background: var(--light-gray); padding: 2rem; border-radius: 12px;">
                                    <h5 style="margin-bottom: 1rem;">Look for businesses that:</h5>
                                    <ul style="list-style: none; padding: 0;">
                                        <li style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="color: var(--success-green);">✅</span>
                                            <strong>Need more leads or appointments</strong> - Service businesses, consultants, contractors
                                        </li>
                                        <li style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="color: var(--success-green);">✅</span>
                                            <strong>Spend money on marketing</strong> - Already advertising online or offline
                                        </li>
                                        <li style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="color: var(--success-green);">✅</span>
                                            <strong>High-value services</strong> - Charge $1,000+ per client (lawyers, coaches, agencies)
                                        </li>
                                        <li style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="color: var(--success-green);">✅</span>
                                            <strong>Growing businesses</strong> - 5+ employees, ready to scale
                                        </li>
                                        <li style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="color: var(--success-green);">✅</span>
                                            <strong>B2B companies</strong> - Sell to other businesses (our specialty!)
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Payment Timeline -->
                            <div style="margin-bottom: 3rem;">
                                <h4 style="color: var(--electric-blue); margin-bottom: 1rem;">⏰ Payment Timeline</h4>
                                <div style="background: var(--light-gray); padding: 2rem; border-radius: 12px;">
                                    <p style="margin-bottom: 1rem;"><strong>When do you get paid?</strong></p>
                                    <ul style="list-style: none; padding: 0;">
                                        <li style="margin-bottom: 1rem;">📅 <strong>Client signs up:</strong> We notify you and update your portal</li>
                                        <li style="margin-bottom: 1rem;">💳 <strong>Client makes first payment:</strong> Usually within 1-7 days of signing</li>
                                        <li style="margin-bottom: 1rem;">💰 <strong>Your commission is processed:</strong> Within 2-3 business days via your chosen payment method</li>
                                    </ul>
                                    <div style="background: var(--electric-blue); color: white; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                        <strong>Typical timeline:</strong> 1-2 weeks from referral to payment in your account!
                                    </div>
                                </div>
                            </div>

                            <!-- Getting Started -->
                            <div style="background: linear-gradient(135deg, var(--electric-blue), #3B82F6); color: white; padding: 2rem; border-radius: 12px;">
                                <h4 style="margin-bottom: 1rem;">🚀 Ready to Start Earning?</h4>
                                <p style="margin-bottom: 1.5rem;">The best part? There's no limit to how many referrals you can submit. The more quality referrals you send us, the more you earn!</p>
                                <div style="text-align: center;">
                                    <button class="btn" onclick="showAffiliateTab(null, 'submit-referral')" style="background: white; color: var(--electric-blue); font-weight: bold;">Submit Your First Referral</button>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Modal for Affiliates -->
    <div id="affiliate-question-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ask a Question</h3>
                <button class="close-modal" onclick="closeQuestionModal()">&times;</button>
            </div>
            <form id="affiliate-question-form">
                <div class="form-group">
                    <label for="question-category">Category</label>
                    <select id="question-category" required>
                        <option value="">Select a category...</option>
                        <option value="payments">💰 Payments & Commissions</option>
                        <option value="referrals">📋 Referral Process</option>
                        <option value="technical">🔧 Technical Support</option>
                        <option value="general">💬 General Question</option>
                        <option value="marketing">📢 Marketing & Promotion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="question-subject">Subject</label>
                    <input type="text" id="question-subject" required placeholder="Brief description of your question">
                </div>
                <div class="form-group">
                    <label for="question-message">Your Question</label>
                    <textarea id="question-message" required placeholder="Please provide as much detail as possible so we can help you effectively..." rows="6"></textarea>
                </div>
                <div style="background: var(--light-gray); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <small style="color: var(--slate-gray);">
                        💡 <strong>Tip:</strong> Our admin team typically responds within 24 hours. You'll see the response right here in your Support section.
                    </small>
                </div>
                <button type="submit" class="btn btn-primary">Submit Question</button>
            </form>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        const SUPABASE_URL = 'https://ngdvepfzmpnfzbecpkhw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nZHZlcGZ6bXBuZnpiZWNwa2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2Nzg2MzksImV4cCI6MjA3NDI1NDYzOX0.bfkXungCd9GkarpR7E7fayXLStewUcDvROTpd_SevFg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let currentUserRole = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 KinectB2B Affiliate Portal Loading...');
            initializeApp();
            setupEventListeners();
        });

        async function initializeApp() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) await handleUserSession(session.user);
                supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN' && session) handleUserSession(session.user);
                    else if (event === 'SIGNED_OUT') handleSignOut();
                });
            } catch (error) {
                console.error('Error initializing app:', error);
                showNotification('Error connecting to server', 'error');
            }
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('affiliate-referral-form').addEventListener('submit', handleAffiliateReferralSubmit);
            document.getElementById('personal-info-form').addEventListener('submit', handlePersonalInfoUpdate);
            document.getElementById('payment-method-form').addEventListener('submit', handlePaymentMethodUpdate);
            document.getElementById('social-links-form').addEventListener('submit', handleSocialLinksUpdate);
            document.getElementById('affiliate-question-form').addEventListener('submit', handleAffiliateQuestion);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                showNotification('Login successful!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function handleUserSession(user) {
            currentUser = user;
            if (user.email === 'robert@kinectb2b.com' || user.user_metadata?.role === 'admin') {
                currentUserRole = 'admin';
                showPortal('admin');
                await loadAdminData();
            } else {
                currentUserRole = 'affiliate';
                showPortal('affiliate');
                await loadAffiliateData();
            }
        }

        function handleSignOut() {
            currentUser = null;
            currentUserRole = null;
            showLogin();
        }

        async function logout() {
            await supabase.auth.signOut();
        }

        function showPortal(type) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            const userName = currentUser?.user_metadata?.full_name || currentUser?.name || 'User';
            document.getElementById('user-name').textContent = `Welcome, ${userName}`;
            if (type === 'admin') {
                document.getElementById('admin-portal').classList.remove('hidden');
                document.getElementById('affiliate-portal').classList.add('hidden');
            } else if (type === 'affiliate') {
                document.getElementById('affiliate-portal').classList.remove('hidden');
                document.getElementById('admin-portal').classList.add('hidden');
            }
        }

        function showLogin() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('admin-portal').classList.add('hidden');
            document.getElementById('affiliate-portal').classList.add('hidden');
        }

        function showAdminLogin() {
            document.getElementById('login-email').value = 'robert@kinectb2b.com';
            document.getElementById('login-password').focus();
        }

        async function loadAdminData() {
            try {
                const { data: affiliates } = await supabase.from('user_profiles').select('*').eq('role', 'affiliate');
                const { data: referrals } = await supabase.from('referrals').select('*');
                const { data: payments } = await supabase.from('payments').select('*');
                console.log('Admin data loaded:', { affiliates, referrals, payments });
                updateAdminStats(affiliates || [], referrals || [], payments || []);
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        function updateAdminStats(affiliates = [], referrals = [], payments = []) {
            const totalAffiliates = affiliates.length;
            const totalReferrals = referrals.length;
            const totalCommissions = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthlyCommissions = payments.filter(p => p.created_at?.startsWith(currentMonth)).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const monthlyRevenue = monthlyCommissions * 10;
            document.getElementById('admin-total-affiliates').textContent = totalAffiliates;
            document.getElementById('admin-total-referrals').textContent = totalReferrals;
            document.getElementById('admin-monthly-revenue').textContent = `$${monthlyRevenue.toFixed(2)}`;
            document.getElementById('admin-total-commissions').textContent = `$${totalCommissions.toFixed(2)}`;
        }

        function showAdminTab(event, tabName) {
            document.querySelectorAll('#admin-portal .tab').forEach(tab => tab.classList.remove('active'));
            const content = document.getElementById('admin-content');
            if (tabName === 'affiliates') loadAffiliatesTab(content);
            else if (tabName === 'referrals-admin') loadReferralsTab(content);
            else if (tabName === 'payments-admin') loadPaymentsTab(content);
            else if (tabName === 'questions-admin') loadQuestionsTab(content);
            if (event && event.target) event.target.classList.add('active');
        }

        async function loadAffiliatesTab(content) {
            try {
                const { data: affiliates } = await supabase.from('user_profiles').select('*').eq('role', 'affiliate').order('created_at', { ascending: false });
                content.innerHTML = `
                    <h3>Affiliate Management (${affiliates?.length || 0})</h3>
                    ${!affiliates || affiliates.length === 0 ? `
                        <div class="empty-state"><div class="empty-state-icon">👥</div><h3>No Affiliates Yet</h3><p>New affiliates will appear here when they sign up.</p></div>
                    ` : `
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
                                <tbody>
                                    ${affiliates.map(affiliate => `
                                        <tr id="affiliate-row-${affiliate.user_id}">
                                            <td><strong>${affiliate.full_name || 'N/A'}</strong></td>
                                            <td>${affiliate.email}</td>
                                            <td>${affiliate.company || 'N/A'}</td>
                                            <td><span class="status-badge status-${(affiliate.status || 'active') === 'active' ? 'active' : 'closed'}">${(affiliate.status || 'active').charAt(0).toUpperCase() + (affiliate.status || 'active').slice(1)}</span></td>
                                            <td>${new Date(affiliate.created_at).toLocaleDateString()}</td>
                                            <td>
                                                <button class="btn btn-small ${(affiliate.status || 'active') === 'active' ? 'btn-danger' : 'btn-success'}" 
                                                        onclick="event.stopPropagation(); toggleAffiliateStatus('${affiliate.user_id}', '${affiliate.status || 'active'}', this);" 
                                                        data-user-id="${affiliate.user_id}"
                                                        data-current-status="${affiliate.status || 'active'}">
                                                    ${(affiliate.status || 'active') === 'active' ? 'Deactivate' : 'Activate'}
                                                </button>
                                                <button class="btn btn-small btn-primary" 
                                                        onclick="event.stopPropagation(); viewAffiliateProfile('${affiliate.user_id}');" 
                                                        style="margin-left: 0.5rem;">
                                                    👤 View Profile
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                `;
            } catch (error) {
                content.innerHTML = '<div class="empty-state"><h3>Error loading affiliates</h3></div>';
            }
        }

        async function loadReferralsTab(content) {
            try {
                const { data: referrals } = await supabase.from('referrals').select('*').order('created_at', { ascending: false });
                const { data: profiles } = await supabase.from('user_profiles').select('user_id, full_name, email');
                const profileMap = {};
                if (profiles) profiles.forEach(profile => profileMap[profile.user_id] = profile);
                content.innerHTML = `
                    <h3>Referral Management (${referrals?.length || 0})</h3>
                    ${!referrals || referrals.length === 0 ? `
                        <div class="empty-state"><div class="empty-state-icon">📋</div><h3>No Referrals Yet</h3><p>Referrals will appear here when affiliates submit them.</p></div>
                    ` : `
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Company</th><th>Contact</th><th>Referred By</th><th>Status</th><th>Pro Plan</th><th>Commission</th><th>Submitted</th><th>Actions</th></tr></thead>
                                <tbody>
                                    ${referrals.map(referral => {
                                        const profile = profileMap[referral.affiliate_id] || {};
                                        const commissionAmount = referral.pro_plan_value ? (parseFloat(referral.pro_plan_value) * 0.1).toFixed(2) : '0.00';
                                        return `
                                            <tr>
                                                <td><strong>${referral.company_name}</strong></td>
                                                <td>${referral.contact_name}<br><small>${referral.contact_email}</small></td>
                                                <td><strong>${profile.full_name || 'Unknown'}</strong><br><small>${profile.email || ''}</small></td>
                                                <td><select onchange="updateReferralStatus('${referral.id}', this.value)" style="padding: 0.25rem; border-radius: 4px; border: 1px solid var(--border-gray);"><option value="pending" ${referral.status === 'pending' ? 'selected' : ''}>Pending</option><option value="contacted" ${referral.status === 'contacted' ? 'selected' : ''}>Contacted</option><option value="customer" ${referral.status === 'customer' ? 'selected' : ''}>Customer</option><option value="closed" ${referral.status === 'closed' ? 'selected' : ''}>Closed</option></select></td>
                                                <td>${referral.pro_plan_value ? `<strong>$${parseFloat(referral.pro_plan_value).toFixed(2)}</strong><br><button class="btn btn-small" onclick="selectProPlan('${referral.id}')" style="background: #f1f5f9; color: #64748B; margin-top: 0.25rem;">Edit Plan</button>` : (referral.status === 'customer' ? `<button class="btn btn-small btn-primary" onclick="selectProPlan('${referral.id}')">Select Plan</button>` : 'N/A')}</td>
                                                <td>${referral.pro_plan_value ? `<strong>$${commissionAmount}</strong>` : 'N/A'}</td>
                                                <td>${new Date(referral.created_at).toLocaleDateString()}</td>
                                                <td>${referral.status === 'customer' && referral.pro_plan_value && !referral.commission_paid ? `<button class="btn btn-small btn-success" onclick="markCommissionPaid('${referral.id}', '${referral.affiliate_id}', ${commissionAmount}, '${referral.company_name}')">Mark as Paid</button>` : (referral.commission_paid ? '<span style="color: var(--success-green);">✓ Paid</span>' : '')}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                `;
            } catch (error) {
                content.innerHTML = '<div class="empty-state"><h3>Error loading referrals</h3></div>';
            }
        }

        async function loadPaymentsTab(content) {
            try {
                console.log('Loading payments tab...');
                
                // Get payments first
                const { data: payments, error: paymentsError } = await supabase
                    .from('payments')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                console.log('Payments query result:', payments, paymentsError);
                
                if (paymentsError) {
                    console.error('Payments error:', paymentsError);
                    throw paymentsError;
                }

                // Get user profiles separately
                const { data: profiles, error: profilesError } = await supabase
                    .from('user_profiles')
                    .select('user_id, full_name, email');
                
                console.log('Profiles query result:', profiles, profilesError);

                // Create profile lookup map
                const profileMap = {};
                if (profiles) {
                    profiles.forEach(profile => {
                        profileMap[profile.user_id] = profile;
                    });
                }

                content.innerHTML = `
                    <h3>Payment Management (${payments?.length || 0})</h3>
                    ${!payments || payments.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">💰</div>
                            <h3>No Payments Yet</h3>
                            <p>Commission payments will appear here.</p>
                        </div>
                    ` : `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Affiliate</th>
                                        <th>Company</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments.map(payment => {
                                        const profile = profileMap[payment.affiliate_id] || {};
                                        return `
                                            <tr>
                                                <td>
                                                    <strong>${profile.full_name || 'Unknown Affiliate'}</strong><br>
                                                    <small>${profile.email || 'No email'}</small>
                                                </td>
                                                <td>${payment.referral_company || 'N/A'}</td>
                                                <td><strong>${parseFloat(payment.amount).toFixed(2)}</strong></td>
                                                <td><span class="status-badge status-active">Completed</span></td>
                                                <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                                                <td><span style="color: var(--success-green);">✓ Paid via External Platform</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                `;
            } catch (error) {
                console.error('Error loading payments:', error);
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <h3>Error Loading Payments</h3>
                        <p>There was an error loading payment data: ${error.message}</p>
                    </div>
                `;
            }
        }

        function loadQuestionsTab(content) {
            loadQuestionsAdminData(content);
        }

        async function loadQuestionsAdminData(content) {
            try {
                const { data: questions } = await supabase
                    .from('questions')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Get user profiles to show affiliate names
                const { data: profiles } = await supabase
                    .from('user_profiles')
                    .select('user_id, full_name, email');

                const profileMap = {};
                if (profiles) {
                    profiles.forEach(profile => {
                        profileMap[profile.user_id] = profile;
                    });
                }

                if (!questions || questions.length === 0) {
                    content.innerHTML = `
                        <h3>Questions & Support (0)</h3>
                        <div class="empty-state">
                            <div class="empty-state-icon">❓</div>
                            <h3>No Questions Yet</h3>
                            <p>Affiliate questions will appear here.</p>
                        </div>
                    `;
                    return;
                }

                const pendingQuestions = questions.filter(q => !q.response);
                const answeredQuestions = questions.filter(q => q.response);

                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3>Questions & Support (${questions.length})</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <span style="color: var(--warning-yellow); font-weight: 600;">⏳ ${pendingQuestions.length} Pending</span>
                            <span style="color: var(--success-green); font-weight: 600;">✅ ${answeredQuestions.length} Answered</span>
                        </div>
                    </div>

                    ${pendingQuestions.length > 0 ? `
                        <div style="margin-bottom: 3rem;">
                            <h4 style="color: var(--warning-yellow); margin-bottom: 1rem;">🚨 Questions Needing Response</h4>
                            ${pendingQuestions.map(q => {
                                const profile = profileMap[q.affiliate_id] || {};
                                return `
                                    <div style="border: 2px solid var(--warning-yellow); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; background: #FFFBEB;">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                            <div>
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <span style="font-size: 1.2rem;">${getCategoryIcon(q.category)}</span>
                                                    <span style="font-size: 0.9rem; color: var(--slate-gray); text-transform: uppercase; font-weight: 600;">${q.category || 'General'}</span>
                                                    <span style="color: var(--slate-gray);">•</span>
                                                    <span style="font-size: 0.9rem; color: var(--slate-gray);">${new Date(q.created_at).toLocaleDateString()}</span>
                                                </div>
                                                <div style="font-weight: 600; font-size: 1.1rem; color: var(--deep-blue);">${q.subject}</div>
                                                <div style="font-size: 0.9rem; color: var(--slate-gray); margin-top: 0.25rem;">
                                                    Asked by: <strong>${profile.full_name || 'Unknown'}</strong> (${profile.email || 'No email'})
                                                </div>
                                            </div>
                                            <span class="status-badge status-pending">⏳ Needs Response</span>
                                        </div>
                                        
                                        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                            <div style="font-size: 0.9rem; color: var(--slate-gray); margin-bottom: 0.5rem;">Question:</div>
                                            <p style="margin: 0; color: var(--deep-blue);">${q.question}</p>
                                        </div>
                                        
                                        <div style="display: flex; gap: 1rem;">
                                            <button class="btn btn-primary btn-small" onclick="respondToQuestion('${q.id}')">📝 Respond</button>
                                            <button class="btn btn-small" onclick="markQuestionRead('${q.id}')" style="background: var(--light-gray); color: var(--slate-gray);">Mark as Read</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}

                    ${answeredQuestions.length > 0 ? `
                        <div>
                            <h4 style="color: var(--success-green); margin-bottom: 1rem;">✅ Answered Questions</h4>
                            ${answeredQuestions.map(q => {
                                const profile = profileMap[q.affiliate_id] || {};
                                return `
                                    <div style="border: 1px solid var(--border-gray); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; background: white;">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                            <div>
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <span style="font-size: 1.2rem;">${getCategoryIcon(q.category)}</span>
                                                    <span style="font-size: 0.9rem; color: var(--slate-gray); text-transform: uppercase; font-weight: 600;">${q.category || 'General'}</span>
                                                    <span style="color: var(--slate-gray);">•</span>
                                                    <span style="font-size: 0.9rem; color: var(--slate-gray);">${new Date(q.created_at).toLocaleDateString()}</span>
                                                </div>
                                                <div style="font-weight: 600; font-size: 1.1rem; color: var(--deep-blue);">${q.subject}</div>
                                                <div style="font-size: 0.9rem; color: var(--slate-gray); margin-top: 0.25rem;">
                                                    Asked by: <strong>${profile.full_name || 'Unknown'}</strong> (${profile.email || 'No email'})
                                                </div>
                                            </div>
                                            <span class="status-badge status-active">✅ Answered</span>
                                        </div>
                                        
                                        <div style="background: var(--light-gray); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                            <div style="font-size: 0.9rem; color: var(--slate-gray); margin-bottom: 0.5rem;">Question:</div>
                                            <p style="margin: 0; color: var(--deep-blue);">${q.question}</p>
                                        </div>
                                        
                                        <div style="background: linear-gradient(135deg, #EBF4FF, #DBEAFE); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--electric-blue);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                <span style="font-weight: 600; color: var(--electric-blue);">Your Response:</span>
                                                <span style="font-size: 0.9rem; color: var(--slate-gray);">${new Date(q.updated_at).toLocaleDateString()}</span>
                                            </div>
                                            <p style="margin: 0; color: var(--deep-blue);">${q.response}</p>
                                        </div>
                                        
                                        <div style="margin-top: 1rem;">
                                            <button class="btn btn-small" onclick="editResponse('${q.id}')" style="background: var(--light-gray); color: var(--slate-gray);">✏️ Edit Response</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Error loading questions:', error);
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <h3>Error Loading Questions</h3>
                        <p>There was an error loading question data.</p>
                    </div>
                `;
            }
        }

        // Admin question response functions
        function respondToQuestion(questionId) {
            const response = prompt('Enter your response to this question:');
            if (response && response.trim()) {
                saveQuestionResponse(questionId, response.trim());
            }
        }

        async function saveQuestionResponse(questionId, response) {
            try {
                const { error } = await supabase
                    .from('questions')
                    .update({ 
                        response: response,
                        status: 'answered',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', questionId);

                if (error) throw error;
                
                showNotification('Response saved successfully!', 'success');
                
                // Reload questions tab
                const content = document.getElementById('admin-content');
                loadQuestionsAdminData(content);

            } catch (error) {
                console.error('Error saving response:', error);
                showNotification('Error saving response', 'error');
            }
        }

        function editResponse(questionId) {
            // Get current response first
            const questionDiv = document.querySelector(`[onclick="editResponse('${questionId}')"]`).closest('div').querySelector('p');
            const currentResponse = questionDiv.textContent;
            
            const newResponse = prompt('Edit your response:', currentResponse);
            if (newResponse && newResponse.trim() && newResponse !== currentResponse) {
                saveQuestionResponse(questionId, newResponse.trim());
            }
        }

        async function markQuestionRead(questionId) {
            try {
                const { error } = await supabase
                    .from('questions')
                    .update({ 
                        status: 'read',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', questionId);

                if (error) throw error;
                
                showNotification('Question marked as read', 'success');
                
                // Reload questions tab
                const content = document.getElementById('admin-content');
                loadQuestionsAdminData(content);

            } catch (error) {
                console.error('Error marking question as read:', error);
                showNotification('Error updating question', 'error');
            }
        }

        async function toggleAffiliateStatus(userId, currentStatus, buttonElement) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            
            console.log('Toggling affiliate status:', { userId, currentStatus, newStatus, buttonElement });
            
            // Disable the specific button to prevent double-clicks
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.textContent = 'Updating...';
            }
            
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ 
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', userId);
                
                if (error) {
                    console.error('Database error:', error);
                    throw error;
                }
                
                console.log('Successfully updated affiliate status');
                showNotification(`Affiliate ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully!`, 'success');
                
                // Update the specific row instead of reloading entire table
                const row = document.getElementById(`affiliate-row-${userId}`);
                if (row) {
                    const statusBadge = row.querySelector('.status-badge');
                    const button = row.querySelector(`[data-user-id="${userId}"]`);
                    
                    // Update status badge
                    if (statusBadge) {
                        statusBadge.className = `status-badge status-${newStatus === 'active' ? 'active' : 'closed'}`;
                        statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                    }
                    
                    // Update button
                    if (button) {
                        button.className = `btn btn-small ${newStatus === 'active' ? 'btn-danger' : 'btn-success'}`;
                        button.textContent = newStatus === 'active' ? 'Deactivate' : 'Activate';
                        button.setAttribute('data-current-status', newStatus);
                        button.setAttribute('onclick', `event.stopPropagation(); toggleAffiliateStatus('${userId}', '${newStatus}', this);`);
                        button.disabled = false;
                    }
                } else {
                    // Fallback: reload the entire affiliates tab
                    const content = document.getElementById('admin-content');
                    loadAffiliatesTab(content);
                }
                
            } catch (error) {
                console.error('Error updating affiliate status:', error);
                showNotification(`Error updating affiliate status: ${error.message}`, 'error');
                
                // Re-enable button on error
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.textContent = currentStatus === 'active' ? 'Deactivate' : 'Activate';
                }
            }
        }

        async function updateReferralStatus(referralId, newStatus) {
            try {
                const { error } = await supabase.from('referrals').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', referralId);
                if (error) throw error;
                showNotification('Referral status updated successfully!', 'success');
                const content = document.getElementById('admin-content');
                loadReferralsTab(content);
            } catch (error) {
                console.error('Error updating referral status:', error);
                showNotification('Error updating referral status', 'error');
            }
        }

        function selectProPlan(referralId) {
            const planOptions = [
                { value: 250, label: 'Pro Plan 100 - $250/month' }, { value: 500, label: 'Pro Plan 200 - $500/month' },
                { value: 750, label: 'Pro Plan 300 - $750/month' }, { value: 1000, label: 'Pro Plan 400 - $1000/month' },
                { value: 1250, label: 'Pro Plan 500 - $1250/month' }, { value: 1500, label: 'Pro Plan 600 - $1500/month' },
                { value: 1750, label: 'Pro Plan 700 - $1750/month' }, { value: 2000, label: 'Pro Plan 800 - $2000/month' },
                { value: 2250, label: 'Pro Plan 900 - $2250/month' }, { value: 2500, label: 'Pro Plan 1000 - $2500/month' },
                { value: 2750, label: 'Pro Plan 1100 - $2750/month' }, { value: 3000, label: 'Pro Plan 1200 - $3000/month' }
            ];
            const planSelect = planOptions.map(plan => `<option value="${plan.value}">${plan.label}</option>`).join('');
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 1rem;">Select Pro Plan</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Choose the plan this customer selected:</label>
                        <select id="plan-select" onchange="toggleCustomPlan()" style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; margin-bottom: 1rem;">
                            <option value="">Select a plan...</option>
                            ${planSelect}
                            <option value="custom">Custom Plan (Enter manually)</option>
                        </select>
                    </div>
                    <div id="custom-plan-section" style="display: none; margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Custom Plan Details:</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                            <input type="text" id="custom-plan-name" placeholder="e.g., Pro Plan 5000" style="padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px;">
                            <input type="number" id="custom-plan-price" placeholder="Monthly price" style="padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="background: #F8FAFC; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; color: #64748B;">Commission will be calculated at 10% of monthly price</div>
                        <div id="commission-preview" style="font-weight: 600; color: #059669; margin-top: 0.5rem;"></div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="savePlanSelection('${referralId}')">Save Plan</button>
                        <button class="btn" onclick="this.closest('div').parentElement.remove()" style="background: #f1f5f9; color: #64748B;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function toggleCustomPlan() {
            const selectValue = document.getElementById('plan-select').value;
            const customSection = document.getElementById('custom-plan-section');
            const commissionPreview = document.getElementById('commission-preview');
            if (selectValue === 'custom') {
                customSection.style.display = 'block';
                commissionPreview.textContent = '';
            } else {
                customSection.style.display = 'none';
                if (selectValue) {
                    const commission = (parseFloat(selectValue) * 0.1).toFixed(2);
                    commissionPreview.textContent = `Commission: $${commission}`;
                } else {
                    commissionPreview.textContent = '';
                }
            }
        }

        async function savePlanSelection(referralId) {
            const planSelect = document.getElementById('plan-select');
            const planValue = planSelect.value;
            let finalPrice, planName;
            if (planValue === 'custom') {
                const customPrice = document.getElementById('custom-plan-price').value;
                const customName = document.getElementById('custom-plan-name').value;
                if (!customPrice || !customName) {
                    showNotification('Please enter custom plan name and price', 'error');
                    return;
                }
                finalPrice = parseFloat(customPrice);
                planName = customName;
            } else if (planValue) {
                finalPrice = parseFloat(planValue);
                planName = planSelect.options[planSelect.selectedIndex].text.split(' - ')[0];
            } else {
                showNotification('Please select a plan', 'error');
                return;
            }
            try {
                const { error } = await supabase.from('referrals').update({ pro_plan_value: finalPrice, updated_at: new Date().toISOString() }).eq('id', referralId);
                if (error) {
                    console.error('Error details:', error);
                    throw error;
                }
                showNotification(`${planName} updated successfully!`, 'success');
                const modal = document.querySelector('[style*="position: fixed"]');
                if (modal) modal.remove();
                const content = document.getElementById('admin-content');
                loadReferralsTab(content);
            } catch (error) {
                console.error('Error saving plan selection:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        async function markCommissionPaid(referralId, affiliateId, commissionAmount, companyName) {
            console.log('markCommissionPaid called with:', { referralId, affiliateId, commissionAmount, companyName });
            if (!confirm(`Mark $${commissionAmount} commission as paid for ${companyName}?`)) return;
            try {
                console.log('Creating payment record...');
                const { data: paymentData, error: paymentError } = await supabase.from('payments').insert([{
                    affiliate_id: affiliateId,
                    referral_id: referralId,
                    amount: parseFloat(commissionAmount),
                    referral_company: companyName,
                    description: `Commission for ${companyName} referral`,
                    status: 'completed',
                    created_at: new Date().toISOString()
                }]).select();
                if (paymentError) {
                    console.error('Payment error:', paymentError);
                    throw paymentError;
                }
                console.log('Payment created:', paymentData);
                console.log('Updating referral...');
                const { error: referralError } = await supabase.from('referrals').update({ commission_paid: true, updated_at: new Date().toISOString() }).eq('id', referralId);
                if (referralError) {
                    console.error('Referral error:', referralError);
                    throw referralError;
                }
                showNotification('Commission marked as paid successfully!', 'success');
                await loadAdminData();
                const content = document.getElementById('admin-content');
                loadReferralsTab(content);
            } catch (error) {
                console.error('Error marking commission as paid:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        // Affiliate Functions
        async function loadAffiliateData() {
            if (!currentUser) return;
            try {
                console.log('Loading affiliate data for user:', currentUser.id);
                
                // Load referrals for this affiliate
                const { data: referrals } = await supabase
                    .from('referrals')
                    .select('*')
                    .eq('affiliate_id', currentUser.id)
                    .order('created_at', { ascending: false });

                // Load payments for this affiliate
                const { data: payments } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('affiliate_id', currentUser.id)
                    .order('created_at', { ascending: false });

                // Load questions for this affiliate
                const { data: questions } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('affiliate_id', currentUser.id)
                    .order('created_at', { ascending: false });

                console.log('Loaded affiliate data:', { referrals, payments, questions });

                updateAffiliateStats(referrals || [], payments || []);
                renderAffiliateReferrals(referrals || []);
                renderAffiliatePayments(payments || []);
                renderAffiliateQuestions(questions || []);

            } catch (error) {
                console.error('Error loading affiliate data:', error);
                showNotification('Error loading your data', 'error');
            }
        }

        function updateAffiliateStats(referrals = [], payments = []) {
            const totalReferrals = referrals.length;
            const activeClients = referrals.filter(r => r.status === 'customer').length;
            const totalEarnings = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthlyEarnings = payments
                .filter(p => p.created_at?.startsWith(currentMonth))
                .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);

            document.getElementById('total-referrals').textContent = totalReferrals;
            document.getElementById('active-clients').textContent = activeClients;
            document.getElementById('monthly-earnings').textContent = `${monthlyEarnings.toFixed(2)}`;
            document.getElementById('total-earnings').textContent = `${totalEarnings.toFixed(2)}`;
        }

        function showAffiliateTab(event, tabName) {
            // Hide all affiliate tab contents
            document.querySelectorAll('#affiliate-content .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all affiliate tabs
            document.querySelectorAll('#affiliate-portal .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show the selected tab content
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Add active class to clicked tab
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find and activate the correct tab
                document.querySelectorAll('#affiliate-portal .tab').forEach(tab => {
                    if ((tabName === 'my-referrals' && tab.textContent.includes('My Referrals')) ||
                        (tabName === 'submit-referral' && tab.textContent.includes('Submit Referral')) ||
                        (tabName === 'my-payments' && tab.textContent.includes('My Payments')) ||
                        (tabName === 'support-qa' && tab.textContent.includes('Support & Q&A')) ||
                        (tabName === 'profile-settings' && tab.textContent.includes('Profile & Payment')) ||
                        (tabName === 'affiliate-info' && tab.textContent.includes('How It Works'))) {
                        tab.classList.add('active');
                    }
                });
            }

            // Load profile data when profile tab is opened
            if (tabName === 'profile-settings') {
                loadAffiliateProfile();
            }
        }

        function renderAffiliateReferrals(referrals = []) {
            const container = document.getElementById('affiliate-referrals-list');
            
            if (referrals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>No Referrals Yet</h3>
                        <p>Submit your first referral to start earning commissions!</p>
                        <button class="btn btn-primary" onclick="showAffiliateTab(null, 'submit-referral')" style="margin-top: 1rem;">Submit Referral</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Plan Value</th>
                                <th>Commission</th>
                                <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${referrals.map(referral => {
                                const commission = referral.pro_plan_value ? (parseFloat(referral.pro_plan_value) * 0.1).toFixed(2) : '0.00';
                                return `
                                    <tr>
                                        <td><strong>${referral.company_name}</strong></td>
                                        <td>${referral.contact_name}<br><small>${referral.contact_email}</small></td>
                                        <td><span class="status-badge status-${referral.status}">${referral.status.charAt(0).toUpperCase() + referral.status.slice(1)}</span></td>
                                        <td>${referral.pro_plan_value ? `${parseFloat(referral.pro_plan_value).toFixed(2)}` : 'TBD'}</td>
                                        <td>${referral.commission_paid ? `<span style="color: var(--success-green);">${commission} ✓</span>` : (referral.pro_plan_value ? `${commission}` : 'TBD')}</td>
                                        <td>${new Date(referral.created_at).toLocaleDateString()}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderAffiliatePayments(payments = []) {
            const container = document.getElementById('affiliate-payments-list');
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💰</div>
                        <h3>No Payments Yet</h3>
                        <p>Payments will appear here once your referrals become active clients.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.map(payment => `
                                <tr>
                                    <td><strong>${payment.referral_company || 'Commission Payment'}</strong></td>
                                    <td style="color: var(--success-green); font-weight: 600;">+${parseFloat(payment.amount).toFixed(2)}</td>
                                    <td><span class="status-badge status-active">Paid</span></td>
                                    <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 2rem; padding: 1rem; background: var(--light-gray); border-radius: 8px;">
                    <strong>Total Earned: ${payments.reduce((sum, p) => sum + parseFloat(p.amount), 0).toFixed(2)}</strong>
                </div>
            `;
        }

        async function handleAffiliateReferralSubmit(e) {
            e.preventDefault();
            
            const formData = {
                company_name: document.getElementById('ref-company-name').value,
                website: document.getElementById('ref-company-website').value || null,
                company_size: document.getElementById('ref-company-size').value || null,
                contact_name: document.getElementById('ref-contact-name').value,
                contact_email: document.getElementById('ref-contact-email').value,
                contact_phone: document.getElementById('ref-contact-phone').value || null,
                notes: document.getElementById('ref-notes').value || null,
                status: 'pending',
                affiliate_id: currentUser.id,
                created_at: new Date().toISOString()
            };

            try {
                console.log('Submitting referral:', formData);
                
                const { data, error } = await supabase
                    .from('referrals')
                    .insert([formData])
                    .select();

                if (error) {
                    console.error('Referral submission error:', error);
                    throw error;
                }
                
                console.log('Referral submitted successfully:', data);
                showNotification('Referral submitted successfully!', 'success');
                
                // Reset form
                document.getElementById('affiliate-referral-form').reset();
                
                // Switch to My Referrals tab
                showAffiliateTab(null, 'my-referrals');
                
                // Reload affiliate data
                await loadAffiliateData();

            } catch (error) {
                console.error('Error submitting referral:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Profile Management Functions
        async function loadAffiliateProfile() {
            try {
                // Get user profile from user_profiles table
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (profile) {
                    // Load personal info
                    document.getElementById('profile-full-name').value = profile.full_name || '';
                    document.getElementById('profile-phone').value = profile.phone || '';
                    document.getElementById('profile-address').value = profile.address || '';
                    document.getElementById('profile-address2').value = profile.address2 || '';
                    document.getElementById('profile-city').value = profile.city || '';
                    document.getElementById('profile-state').value = profile.state || '';
                    document.getElementById('profile-zip').value = profile.zip || '';

                    // Load payment method
                    if (profile.payment_method) {
                        const paymentMethod = profile.payment_method;
                        document.getElementById(`payment-${paymentMethod}`).checked = true;
                        selectPaymentMethod(paymentMethod);

                        // Load payment details
                        if (paymentMethod === 'paypal') {
                            document.getElementById('paypal-email').value = profile.paypal_email || '';
                        } else if (paymentMethod === 'zelle') {
                            document.getElementById('zelle-email').value = profile.zelle_email || '';
                            document.getElementById('zelle-phone').value = profile.zelle_phone || '';
                        } else if (paymentMethod === 'cashapp') {
                            document.getElementById('cashapp-tag').value = profile.cashapp_tag || '';
                        } else if (paymentMethod === 'ach') {
                            document.getElementById('ach-account').value = profile.ach_account || '';
                            document.getElementById('ach-routing').value = profile.ach_routing || '';
                            document.getElementById('ach-bank-name').value = profile.ach_bank_name || '';
                        }
                    }

                    // Load social links
                    document.getElementById('social-facebook').value = profile.social_facebook || '';
                    document.getElementById('social-instagram').value = profile.social_instagram || '';
                    document.getElementById('social-linkedin').value = profile.social_linkedin || '';
                    document.getElementById('social-twitter').value = profile.social_twitter || '';
                    document.getElementById('social-youtube').value = profile.social_youtube || '';
                    document.getElementById('social-website').value = profile.social_website || '';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function selectPaymentMethod(method) {
            // Hide all payment detail sections
            document.querySelectorAll('.payment-details').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected payment method details
            document.getElementById(method + '-details').style.display = 'block';

            // Update radio button styling
            document.querySelectorAll('input[name="payment-method"]').forEach(input => {
                const label = input.parentElement;
                if (input.value === method) {
                    label.style.borderColor = 'var(--electric-blue)';
                    label.style.backgroundColor = '#EBF4FF';
                } else {
                    label.style.borderColor = 'var(--border-gray)';
                    label.style.backgroundColor = 'white';
                }
            });
        }

        async function handlePersonalInfoUpdate(e) {
            e.preventDefault();

            const personalData = {
                full_name: document.getElementById('profile-full-name').value,
                phone: document.getElementById('profile-phone').value,
                address: document.getElementById('profile-address').value,
                address2: document.getElementById('profile-address2').value,
                city: document.getElementById('profile-city').value,
                state: document.getElementById('profile-state').value,
                zip: document.getElementById('profile-zip').value,
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .upsert({
                        user_id: currentUser.id,
                        email: currentUser.email,
                        role: 'affiliate',
                        ...personalData
                    });

                if (error) throw error;
                showNotification('Personal information updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating personal info:', error);
                showNotification('Error updating personal information', 'error');
            }
        }

        async function handlePaymentMethodUpdate(e) {
            e.preventDefault();

            const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value;
            if (!paymentMethod) {
                showNotification('Please select a payment method', 'error');
                return;
            }

            const paymentData = {
                payment_method: paymentMethod,
                updated_at: new Date().toISOString()
            };

            // Get payment method specific data
            if (paymentMethod === 'paypal') {
                paymentData.paypal_email = document.getElementById('paypal-email').value;
                if (!paymentData.paypal_email) {
                    showNotification('Please enter your PayPal email', 'error');
                    return;
                }
            } else if (paymentMethod === 'zelle') {
                paymentData.zelle_email = document.getElementById('zelle-email').value;
                paymentData.zelle_phone = document.getElementById('zelle-phone').value;
                if (!paymentData.zelle_email && !paymentData.zelle_phone) {
                    showNotification('Please enter either email or phone for Zelle', 'error');
                    return;
                }
            } else if (paymentMethod === 'cashapp') {
                paymentData.cashapp_tag = document.getElementById('cashapp-tag').value;
                if (!paymentData.cashapp_tag) {
                    showNotification('Please enter your Cash App tag', 'error');
                    return;
                }
            } else if (paymentMethod === 'ach') {
                paymentData.ach_account = document.getElementById('ach-account').value;
                paymentData.ach_routing = document.getElementById('ach-routing').value;
                paymentData.ach_bank_name = document.getElementById('ach-bank-name').value;
                if (!paymentData.ach_account || !paymentData.ach_routing) {
                    showNotification('Please enter both account and routing numbers', 'error');
                    return;
                }
            }

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .upsert({
                        user_id: currentUser.id,
                        email: currentUser.email,
                        role: 'affiliate',
                        ...paymentData
                    });

                if (error) throw error;
                showNotification('Payment method saved successfully!', 'success');
            } catch (error) {
                console.error('Error updating payment method:', error);
                showNotification('Error saving payment method', 'error');
            }
        }

        async function handleSocialLinksUpdate(e) {
            e.preventDefault();

            const socialData = {
                social_facebook: document.getElementById('social-facebook').value,
                social_instagram: document.getElementById('social-instagram').value,
                social_linkedin: document.getElementById('social-linkedin').value,
                social_twitter: document.getElementById('social-twitter').value,
                social_youtube: document.getElementById('social-youtube').value,
                social_website: document.getElementById('social-website').value,
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .upsert({
                        user_id: currentUser.id,
                        email: currentUser.email,
                        role: 'affiliate',
                        ...socialData
                    });

                if (error) throw error;
                showNotification('Social links updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating social links:', error);
                showNotification('Error saving social links', 'error');
            }
        }

        // Question/Support Functions
        function renderAffiliateQuestions(questions = []) {
            const container = document.getElementById('affiliate-questions-list');
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❓</div>
                        <h3>No Questions Yet</h3>
                        <p>Have a question about the affiliate program, payments, or need help? Our team is here to help!</p>
                        <button class="btn btn-primary" onclick="openQuestionModal()" style="margin-top: 1rem;">Ask Your First Question</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = questions.map(q => `
                <div style="border: 1px solid var(--border-gray); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.2rem;">${getCategoryIcon(q.category)}</span>
                                <span style="font-size: 0.9rem; color: var(--slate-gray); text-transform: uppercase; font-weight: 600;">${q.category || 'General'}</span>
                                <span style="color: var(--slate-gray);">•</span>
                                <span style="font-size: 0.9rem; color: var(--slate-gray);">${new Date(q.created_at).toLocaleDateString()}</span>
                            </div>
                            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">${q.subject}</div>
                        </div>
                        <span class="status-badge status-${q.response ? 'active' : 'pending'}">
                            ${q.response ? '✅ Answered' : '⏳ Pending'}
                        </span>
                    </div>
                    
                    <div style="background: var(--light-gray); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; color: var(--slate-gray); margin-bottom: 0.5rem;">Your Question:</div>
                        <p style="margin: 0; color: var(--deep-blue);">${q.question}</p>
                    </div>
                    
                    ${q.response ? `
                        <div style="background: linear-gradient(135deg, #EBF4FF, #DBEAFE); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--electric-blue);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: var(--electric-blue);">🎯 Admin Response:</span>
                                <span style="font-size: 0.9rem; color: var(--slate-gray);">${new Date(q.updated_at).toLocaleDateString()}</span>
                            </div>
                            <p style="margin: 0; color: var(--deep-blue);">${q.response}</p>
                        </div>
                    ` : `
                        <div style="background: #FEF3C7; padding: 1rem; border-radius: 8px; color: #92400E;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>⏰</span>
                                <span>Our team will respond within 24 hours. You'll see the answer right here!</span>
                            </div>
                        </div>
                    `}
                </div>
            `).join('');
        }

        function getCategoryIcon(category) {
            const icons = {
                'payments': '💰',
                'referrals': '📋',
                'technical': '🔧',
                'general': '💬',
                'marketing': '📢'
            };
            return icons[category] || '❓';
        }

        function openQuestionModal() {
            document.getElementById('affiliate-question-modal').classList.add('active');
        }

        function closeQuestionModal() {
            document.getElementById('affiliate-question-modal').classList.remove('active');
            document.getElementById('affiliate-question-form').reset();
        }

        async function handleAffiliateQuestion(e) {
            e.preventDefault();
            
            const questionData = {
                affiliate_id: currentUser.id,
                category: document.getElementById('question-category').value,
                subject: document.getElementById('question-subject').value,
                question: document.getElementById('question-message').value,
                status: 'pending',
                created_at: new Date().toISOString()
            };

            try {
                console.log('Submitting question:', questionData);
                
                const { data, error } = await supabase
                    .from('questions')
                    .insert([questionData])
                    .select();

                if (error) {
                    console.error('Question submission error:', error);
                    throw error;
                }
                
                console.log('Question submitted successfully:', data);
                showNotification('Question submitted successfully! Our team will respond within 24 hours.', 'success');
                
                // Close modal and reset form
                closeQuestionModal();
                
                // Reload affiliate data to show the new question
                await loadAffiliateData();

            } catch (error) {
                console.error('Error submitting question:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Modal click outside to close
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // Affiliate Profile Management
        async function viewAffiliateProfile(userId) {
            try {
                console.log('Loading affiliate profile for user:', userId);
                
                // Get affiliate profile details
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', userId)
                    .single();

                // Get affiliate referrals
                const { data: referrals } = await supabase
                    .from('referrals')
                    .select('*')
                    .eq('affiliate_id', userId)
                    .order('created_at', { ascending: false });

                // Get affiliate payments
                const { data: payments } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('affiliate_id', userId)
                    .order('created_at', { ascending: false });

                // Get affiliate questions
                const { data: questions } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('affiliate_id', userId)
                    .order('created_at', { ascending: false });

                console.log('Loaded affiliate data:', { profile, referrals, payments, questions });

                displayAffiliateProfile(profile, referrals || [], payments || [], questions || []);
                
            } catch (error) {
                console.error('Error loading affiliate profile:', error);
                showNotification('Error loading affiliate profile', 'error');
            }
        }

        function displayAffiliateProfile(profile, referrals, payments, questions) {
            if (!profile) {
                showNotification('Affiliate profile not found', 'error');
                return;
            }

            // Calculate statistics
            const totalReferrals = referrals.length;
            const activeReferrals = referrals.filter(r => r.status === 'customer').length;
            const totalEarnings = payments.reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const pendingQuestions = questions.filter(q => !q.response).length;

            // Set modal title
            document.getElementById('affiliate-profile-title').textContent = `${profile.full_name || 'Unknown'} - Affiliate Profile`;

            // Build profile content
            document.getElementById('affiliate-profile-content').innerHTML = `
                <!-- Profile Header -->
                <div style="background: linear-gradient(135deg, var(--electric-blue), #3B82F6); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; color: white;">${profile.full_name || 'Unknown Name'}</h2>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">${profile.email}</p>
                            <p style="margin: 0.25rem 0 0 0; opacity: 0.8;">Joined: ${new Date(profile.created_at).toLocaleDateString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <select onchange="updateAffiliateStatus('${profile.user_id}', this.value)" style="padding: 0.5rem; border-radius: 6px; border: none;">
                                    <option value="active" ${(profile.status || 'active') === 'active' ? 'selected' : ''}>🟢 Active</option>
                                    <option value="paused" ${profile.status === 'paused' ? 'selected' : ''}>🟡 Paused</option>
                                    <option value="inactive" ${profile.status === 'inactive' ? 'selected' : ''}>🔴 Inactive</option>
                                </select>
                            </div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">Status: <strong>${(profile.status || 'active').charAt(0).toUpperCase() + (profile.status || 'active').slice(1)}</strong></div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: white; border: 1px solid var(--border-gray); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--electric-blue); margin-bottom: 0.5rem;">${totalReferrals}</div>
                        <div style="color: var(--slate-gray);">Total Referrals</div>
                    </div>
                    <div style="background: white; border: 1px solid var(--border-gray); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--success-green); margin-bottom: 0.5rem;">${activeReferrals}</div>
                        <div style="color: var(--slate-gray);">Active Clients</div>
                    </div>
                    <div style="background: white; border: 1px solid var(--border-gray); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--success-green); margin-bottom: 0.5rem;">${totalEarnings.toFixed(2)}</div>
                        <div style="color: var(--slate-gray);">Total Earned</div>
                    </div>
                    <div style="background: white; border: 1px solid var(--border-gray); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: ${pendingQuestions > 0 ? 'var(--warning-yellow)' : 'var(--slate-gray)'}; margin-bottom: 0.5rem;">${pendingQuestions}</div>
                        <div style="color: var(--slate-gray);">Pending Questions</div>
                    </div>
                </div>

                <!-- Profile Details Tabs -->
                <div style="background: white; border-radius: 12px; padding: 0; overflow: hidden; border: 1px solid var(--border-gray);">
                    <div style="display: flex; border-bottom: 1px solid var(--border-gray);">
                        <button class="profile-tab active" onclick="showProfileTab(event, 'contact-info')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid var(--electric-blue);">Contact Info</button>
                        <button class="profile-tab" onclick="showProfileTab(event, 'payment-info')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer;">Payment Info</button>
                        <button class="profile-tab" onclick="showProfileTab(event, 'promotion-links')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer;">Promotion</button>
                        <button class="profile-tab" onclick="showProfileTab(event, 'referrals-history')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer;">Referrals (${totalReferrals})</button>
                        <button class="profile-tab" onclick="showProfileTab(event, 'earnings-history')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer;">Earnings (${payments.length})</button>
                    </div>

                    <div style="padding: 2rem;">
                        <!-- Contact Info Tab -->
                        <div id="contact-info" class="profile-tab-content">
                            <h4 style="margin-bottom: 1rem; color: var(--electric-blue);">Contact Information</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <div style="margin-bottom: 1rem;">
                                        <strong>Full Name:</strong><br>
                                        <span style="color: var(--slate-gray);">${profile.full_name || 'Not provided'}</span>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <strong>Email:</strong><br>
                                        <span style="color: var(--slate-gray);">${profile.email || 'Not provided'}</span>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <strong>Phone:</strong><br>
                                        <span style="color: var(--slate-gray);">${profile.phone || 'Not provided'}</span>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <strong>Company:</strong><br>
                                        <span style="color: var(--slate-gray);">${profile.company || 'Not provided'}</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="margin-bottom: 1rem;">
                                        <strong>Mailing Address:</strong><br>
                                        <span style="color: var(--slate-gray);">
                                            ${profile.address || 'Not provided'}<br>
                                            ${profile.address2 ? profile.address2 + '<br>' : ''}
                                            ${profile.city || ''} ${profile.state || ''} ${profile.zip || ''}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Info Tab -->
                        <div id="payment-info" class="profile-tab-content" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: var(--electric-blue);">Payment Information</h4>
                            ${profile.payment_method ? `
                                <div style="background: var(--light-gray); padding: 1.5rem; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                        <span style="font-size: 1.5rem;">${getPaymentIcon(profile.payment_method)}</span>
                                        <strong style="text-transform: capitalize;">${profile.payment_method} Payment</strong>
                                    </div>
                                    ${getPaymentDetails(profile)}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 2rem; color: var(--slate-gray);">
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">💳</div>
                                    <p>No payment method configured yet</p>
                                </div>
                            `}
                        </div>

                        <!-- Promotion Links Tab -->
                        <div id="promotion-links" class="profile-tab-content" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: var(--electric-blue);">Promotion Channels</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                ${getSocialLinksDisplay(profile)}
                            </div>
                        </div>

                        <!-- Referrals History Tab -->
                        <div id="referrals-history" class="profile-tab-content" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: var(--electric-blue);">Referral History</h4>
                            ${getReferralsTable(referrals)}
                        </div>

                        <!-- Earnings History Tab -->
                        <div id="earnings-history" class="profile-tab-content" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: var(--electric-blue);">Earnings History</h4>
                            ${getEarningsTable(payments)}
                        </div>
                    </div>
                </div>
            `;

            // Show modal
            document.getElementById('affiliate-profile-modal').classList.add('active');
        }

        function getPaymentIcon(method) {
            const icons = {
                'paypal': '💰',
                'zelle': '📱',
                'cashapp': '💸',
                'ach': '🏦'
            };
            return icons[method] || '💳';
        }

        function getPaymentDetails(profile) {
            switch(profile.payment_method) {
                case 'paypal':
                    return `<p><strong>PayPal Email:</strong> ${profile.paypal_email || 'Not provided'}</p>`;
                case 'zelle':
                    return `
                        <p><strong>Zelle Email:</strong> ${profile.zelle_email || 'Not provided'}</p>
                        <p><strong>Zelle Phone:</strong> ${profile.zelle_phone || 'Not provided'}</p>
                    `;
                case 'cashapp':
                    return `<p><strong>Cash App Tag:</strong> ${profile.cashapp_tag || 'Not provided'}</p>`;
                case 'ach':
                    return `
                        <p><strong>Account Number:</strong> ${profile.ach_account ? '*'.repeat(profile.ach_account.length - 4) + profile.ach_account.slice(-4) : 'Not provided'}</p>
                        <p><strong>Routing Number:</strong> ${profile.ach_routing || 'Not provided'}</p>
                        <p><strong>Bank Name:</strong> ${profile.ach_bank_name || 'Not provided'}</p>
                    `;
                default:
                    return '<p>No payment details available</p>';
            }
        }

        function getSocialLinksDisplay(profile) {
            const socialLinks = [
                { key: 'social_facebook', label: '🔗 Facebook', value: profile.social_facebook },
                { key: 'social_instagram', label: '📸 Instagram', value: profile.social_instagram },
                { key: 'social_linkedin', label: '💼 LinkedIn', value: profile.social_linkedin },
                { key: 'social_twitter', label: '🐦 Twitter/X', value: profile.social_twitter },
                { key: 'social_youtube', label: '📺 YouTube', value: profile.social_youtube },
                { key: 'social_website', label: '🌐 Website', value: profile.social_website }
            ];

            const hasAnyLinks = socialLinks.some(link => link.value);

            if (!hasAnyLinks) {
                return `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--slate-gray);">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">📢</div>
                        <p>No social media links provided yet</p>
                    </div>
                `;
            }

            return socialLinks.map(link => `
                <div style="margin-bottom: 1rem;">
                    <strong>${link.label}:</strong><br>
                    ${link.value ? 
                        `<a href="${link.value}" target="_blank" style="color: var(--electric-blue); text-decoration: none;">${link.value}</a>` : 
                        '<span style="color: var(--slate-gray);">Not provided</span>'
                    }
                </div>
            `).join('');
        }

        function getReferralsTable(referrals) {
            if (referrals.length === 0) {
                return `
                    <div style="text-align: center; padding: 2rem; color: var(--slate-gray);">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">📋</div>
                        <p>No referrals submitted yet</p>
                    </div>
                `;
            }

            return `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light-gray);">
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Company</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Status</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Plan Value</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Commission</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${referrals.map(referral => {
                                const commission = referral.pro_plan_value ? (parseFloat(referral.pro_plan_value) * 0.1).toFixed(2) : '0.00';
                                return `
                                    <tr>
                                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                            <strong>${referral.company_name}</strong><br>
                                            <small style="color: var(--slate-gray);">${referral.contact_name} - ${referral.contact_email}</small>
                                        </td>
                                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                            <span class="status-badge status-${referral.status}">${referral.status.charAt(0).toUpperCase() + referral.status.slice(1)}</span>
                                        </td>
                                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                            ${referral.pro_plan_value ? `${parseFloat(referral.pro_plan_value).toFixed(2)}` : 'TBD'}
                                        </td>
                                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                            ${referral.commission_paid ? 
                                                `<span style="color: var(--success-green);">${commission} ✅</span>` : 
                                                (referral.pro_plan_value ? `${commission}` : 'TBD')
                                            }
                                        </td>
                                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                            ${new Date(referral.created_at).toLocaleDateString()}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getEarningsTable(payments) {
            if (payments.length === 0) {
                return `
                    <div style="text-align: center; padding: 2rem; color: var(--slate-gray);">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">💰</div>
                        <p>No earnings yet</p>
                    </div>
                `;
            }

            const totalEarnings = payments.reduce((sum, p) => sum + parseFloat(p.amount), 0);

            return `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light-gray);">
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Company</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Amount</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Date</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-gray);">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.map(payment => `
                                <tr>
                                    <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                        <strong>${payment.referral_company || 'Commission Payment'}</strong>
                                    </td>
                                    <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                        <span style="color: var(--success-green); font-weight: 600;">+${parseFloat(payment.amount).toFixed(2)}</span>
                                    </td>
                                    <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                        ${new Date(payment.created_at).toLocaleDateString()}
                                    </td>
                                    <td style="padding: 1rem; border-bottom: 1px solid var(--border-gray);">
                                        <span class="status-badge status-active">Paid</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--light-gray); border-radius: 8px; text-align: right;">
                        <strong style="color: var(--success-green); font-size: 1.2rem;">Total Earned: ${totalEarnings.toFixed(2)}</strong>
                    </div>
                </div>
            `;
        }

        function showProfileTab(event, tabName) {
            // Remove active class from all profile tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.borderBottom = 'none';
            });

            // Hide all profile tab contents
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Show selected tab content
            document.getElementById(tabName).style.display = 'block';

            // Add active class to clicked tab
            if (event && event.target) {
                event.target.classList.add('active');
                event.target.style.borderBottom = '3px solid var(--electric-blue)';
            }
        }

        function closeAffiliateProfile() {
            document.getElementById('affiliate-profile-modal').classList.remove('active');
        }

        async function updateAffiliateStatus(userId, newStatus) {
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ 
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', userId);
                
                if (error) throw error;
                
                showNotification(`Affiliate status updated to ${newStatus}!`, 'success');
                
                // Also reload the main affiliates tab if it's open
                const content = document.getElementById('admin-content');
                if (content.innerHTML.includes('Affiliate Management')) {
                    loadAffiliatesTab(content);
                }
                
            } catch (error) {
                console.error('Error updating affiliate status:', error);
                showNotification('Error updating affiliate status', 'error');
            }
        }
    </script>
</body>
</html>
